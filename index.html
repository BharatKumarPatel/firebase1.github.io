<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1280">
    <title>VYUHA | MASTER CONSOLE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="loader" class="fullscreen-overlay">
        <div class="spinner"></div>
        <div class="mono-text">INITIALIZING VYUHA...</div>
    </div>

    <div id="login" class="fullscreen-overlay">
        <div class="login-card">
            <img src="logo.png" alt="VYUHA" class="login-logo">
            <h1 class="login-title">ACCESS TERMINAL</h1>
            
            <input type="email" id="email" class="input-std" placeholder="IDENTIFIER (EMAIL)" autocomplete="off">
            <input type="password" id="pass" class="input-std" placeholder="ACCESS KEY">
            
            <button id="btnLogin" class="btn-primary">CONNECT</button>
            <div id="loginMsg" class="error-msg"></div>
        </div>
    </div>

    <div id="app" class="hidden">
        
        <aside class="sidebar">
            <div class="brand-area">
                <img src="logo.png" alt="Logo" class="sidebar-logo">
            </div>

            <div class="user-block desktop-only">
                <div id="uAvatar" class="avatar-circle"></div>
                <div>
                    <div id="uName" class="u-name">USER</div>
                    <div id="uRole" class="u-role">UNIT</div>
                </div>
            </div>

            <nav class="nav-menu">
                <button class="nav-btn active" onclick="app.switchTab('profile')">
                    <i class="ph-bold ph-identification-card"></i>
                    <span>IDENTITY</span>
                </button>
                <button class="nav-btn" onclick="app.switchTab('ai')">
                    <i class="ph-bold ph-brain"></i>
                    <span>NEURAL</span>
                </button>
                <button id="navAdmin" class="nav-btn hidden" onclick="app.switchTab('admin')">
                    <i class="ph-bold ph-command"></i>
                    <span>WAR ROOM</span>
                </button>
            </nav>

            <div class="logout-area">
                <button onclick="app.logout()" class="logout-btn">
                    <i class="ph-bold ph-power"></i>
                    <span>EXIT</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="content-padder">
                
                <section id="tab-profile" class="tab-view">
                    <div class="head-row">
                        <h2>IDENTITY CONFIGURATION</h2>
                        <p class="mono-text">UNIT CREDENTIALS & PUBLIC PROFILE</p>
                    </div>

                    <div id="statsGrid" class="stats-grid hidden">
                        <div class="stat-box">
                            <label>RANK</label>
                            <span id="vRank">--</span>
                        </div>
                        <div class="stat-box">
                            <label>WINS</label>
                            <span id="vWins">0</span>
                        </div>
                        <div class="stat-box">
                            <label>MATCHES</label>
                            <span id="vMatches">0</span>
                        </div>
                        <div class="stat-box">
                            <label>STATUS</label>
                            <span id="vStatus" class="active-txt">ACTIVE</span>
                        </div>
                    </div>

                    <div class="form-layout">
                        <div class="row-2">
                            <div class="field-group">
                                <label>UNIT NAME <span class="tag black">LOCKED</span></label>
                                <input type="text" id="p_name" class="input-std locked" disabled>
                            </div>
                            <div class="field-group">
                                <label>BOT ID <span class="tag black">LOCKED</span></label>
                                <input type="text" id="p_botName" class="input-std locked" disabled>
                            </div>
                        </div>

                        <div class="row-2">
                            <div class="field-group">
                                <label>BASE CITY</label>
                                <input type="text" id="p_city" class="input-std">
                            </div>
                            <div class="field-group" id="grp_school">
                                <label>AFFILIATION</label>
                                <input type="text" id="p_link" class="input-std">
                            </div>
                        </div>

                        <div class="row-2">
                            <div class="field-group">
                                <label>EMAIL (READ ONLY)</label>
                                <input type="text" id="p_email" class="input-std locked" disabled>
                            </div>
                            <div class="field-group" id="grp_mobile">
                                <label>MOBILE CONTACT</label>
                                <input type="text" id="p_mobile" class="input-std">
                            </div>
                        </div>

                        <div class="field-group" id="grp_logo">
                            <label>VISUAL AVATAR</label>
                            <div id="logoList" class="logo-row"></div>
                            <input type="hidden" id="p_logo_val">
                        </div>

                        <div class="field-group">
                            <label>BIO / MANIFESTO</label>
                            <textarea id="p_bio" class="input-std area"></textarea>
                        </div>

                        <div class="field-group highlight">
                            <label>UPDATE ACCESS KEY (PASSWORD)</label>
                            <input type="text" id="p_pass" class="input-std" placeholder="ENTER NEW STRONG PASSWORD">
                            <div class="hint">MUST BE 8+ CHARS WITH SYMBOL & NUMBER</div>
                        </div>
                    </div>
                </section>

                <section id="tab-ai" class="tab-view hidden">
                    <div class="head-row">
                        <h2>NEURAL LOGIC</h2>
                        <p class="mono-text">API & BATTLE STRATEGIES</p>
                    </div>

                    <div class="form-layout">
                        <div class="field-group">
                            <label>GEMINI API KEY <span class="tag gray">VISIBLE</span></label>
                            <input type="text" id="ai_key" class="input-std code" placeholder="PASTE KEY HERE...">
                        </div>
                        <div class="field-group">
                            <label>MODEL VERSION</label>
                            <input type="text" id="ai_model" class="input-std code" value="gemini-2.5-flash">
                        </div>
                        <div class="field-group">
                            <label>GLOBAL SYSTEM PROMPT</label>
                            <textarea id="ai_global" class="input-std area code"></textarea>
                        </div>
                    </div>

                    <div class="divider">ROOM OVERRIDES</div>
                    <div id="roomPrompts" class="form-layout"></div>
                </section>

                <section id="tab-admin" class="tab-view hidden">
                    <div class="head-row">
                        <h2>WAR ROOM MANAGER</h2>
                        <p class="mono-text">DEPLOY & DESTROY SECTORS</p>
                    </div>

                    <div class="admin-panel">
                        <h3>DEPLOY NEW SECTOR</h3>
                        <div class="row-3-btn">
                            <input type="text" id="new_r_name" class="input-std" placeholder="NAME">
                            <input type="text" id="new_r_topic" class="input-std" placeholder="TOPIC">
                            <select id="new_r_diff" class="input-std">
                                <option>Easy</option><option>Medium</option><option>Hard</option>
                            </select>
                            <button onclick="app.createRoom()" class="btn-black">ADD</button>
                        </div>
                    </div>

                    <div class="divider">ACTIVE SECTORS</div>
                    <div id="adminRoomList" class="room-list"></div>
                </section>

                <div style="height: 120px;"></div>
            </div>
        </main>

        <div class="action-bar">
            <div class="support">
                <i class="ph-bold ph-lifebuoy"></i>
                <a href="mailto:ibbchoudhary@gmail.com">IBBCHOUDHARY@GMAIL.COM</a>
            </div>
            <button id="btnSave" onclick="app.saveData()" class="btn-save">SAVE CHANGES</button>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, get, update, set, remove, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // !!! PASTE API KEY BELOW !!!
        const firebaseConfig = {
             apiKey: "AIzaSyBdK4ZRrRcmisVVOW_hTMIowtts2I4iGzA",
  authDomain: "ai-quizz-97fb9.firebaseapp.com",
  databaseURL: "https://ai-quizz-97fb9-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "ai-quizz-97fb9",
  storageBucket: "ai-quizz-97fb9.firebasestorage.app",
  messagingSenderId: "572423560278",
  appId: "1:572423560278:web:c15c0e8a14b452068f2ff7"
        };

        const appInstance = initializeApp(firebaseConfig);
        const db = getDatabase(appInstance);

        // State
        let currentUser = null;
        let userPath = null;
        let userRole = null;

        // --- APP FUNCTIONS NAMESPACE ---
        window.app = {
            
            // 1. INIT
            init: () => {
                const session = sessionStorage.getItem("vyuha_sess");
                if(session) {
                    const d = JSON.parse(session);
                    app.loadSuccess(d.path, d.role, d.user);
                } else {
                    document.getElementById("loader").classList.add("hidden");
                }
            },

            // 2. LOGIN
            login: async () => {
                const email = document.getElementById("email").value.trim();
                const pass = document.getElementById("pass").value.trim();
                const msg = document.getElementById("loginMsg");
                const btn = document.getElementById("btnLogin");

                if(!email || !pass) { msg.innerText = "CREDENTIALS MISSING"; return; }

                btn.innerText = "VERIFYING...";
                msg.innerText = "";

                try {
                    // Check Admin
                    const adminSnap = await get(child(ref(db), "system_config/admin_profile"));
                    if(adminSnap.exists() && adminSnap.val().email === email && adminSnap.val().password === pass) {
                        app.loadSuccess("system_config/admin_profile", "ADMIN", adminSnap.val());
                        return;
                    }

                    // Check Students
                    let found = false;
                    const studSnap = await get(child(ref(db), "students"));
                    if(studSnap.exists()) {
                        studSnap.forEach(s => {
                            const val = s.val();
                            if(val.private_info.email === email && val.private_info.password === pass) {
                                app.loadSuccess(`students/${s.key}`, "STUDENT", {...val.public_info, ...val.private_info, key: s.key});
                                found = true;
                            }
                        });
                    }
                    if(found) return;

                    // Check Schools
                    const schSnap = await get(child(ref(db), "schools"));
                    if(schSnap.exists()) {
                        schSnap.forEach(s => {
                            const val = s.val();
                            if(val.private_info.email === email && val.private_info.password === pass) {
                                app.loadSuccess(`schools/${s.key}`, "SCHOOL", {...val.public_info, ...val.private_info, key: s.key});
                                found = true;
                            }
                        });
                    }
                    if(found) return;

                    msg.innerText = "ACCESS DENIED";
                    btn.innerText = "CONNECT";

                } catch(e) {
                    console.error(e);
                    msg.innerText = "CONNECTION ERROR";
                    btn.innerText = "CONNECT";
                }
            },

            // 3. LOAD DASHBOARD
            loadSuccess: (path, role, data) => {
                currentUser = data; userPath = path; userRole = role;
                sessionStorage.setItem("vyuha_sess", JSON.stringify({path, role, user: data}));

                document.getElementById("login").classList.add("hidden");
                document.getElementById("loader").classList.add("hidden");
                document.getElementById("app").classList.remove("hidden");
                document.getElementById("app").style.display = "flex"; // Force Flex for layout

                // Render Data
                const name = data.name || data.key || "USER";
                document.getElementById("uName").innerText = name;
                document.getElementById("uRole").innerText = role;
                
                // Avatar
                const av = data.avatarUrl || data.logoUrl || `https://api.dicebear.com/7.x/initials/svg?seed=${name}`;
                document.getElementById("uAvatar").style.backgroundImage = `url('${av}')`;

                // Common Fields
                document.getElementById("p_name").value = name;
                document.getElementById("p_city").value = data.city || "";
                document.getElementById("p_email").value = data.email || "";
                document.getElementById("p_pass").value = data.password || "";
                document.getElementById("p_bio").value = data.bio || "";
                document.getElementById("ai_key").value = data.apiKey || "";
                document.getElementById("ai_model").value = data.model || "gemini-2.5-flash";
                document.getElementById("ai_global").value = data.globalPrompt || "";

                // Role Logic
                if(role === "ADMIN") {
                    document.getElementById("navAdmin").classList.remove("hidden");
                    document.getElementById("statsGrid").classList.add("hidden");
                    document.getElementById("grp_school").classList.add("hidden");
                    document.getElementById("grp_mobile").classList.add("hidden");
                    document.getElementById("grp_logo").classList.add("hidden");
                    document.getElementById("p_botName").value = "SUPREME AI JUSTICE";
                    app.loadAdminRooms();
                } 
                else if (role === "STUDENT") {
                    document.getElementById("p_botName").value = data.botName || "NOT_SET";
                    document.getElementById("p_mobile").value = data.mobile || "";
                    document.getElementById("p_link").value = data.linkedSchool || data.className || "";
                    document.getElementById("vRank").innerText = data.currentRank || "N/A";
                    document.getElementById("vWins").innerText = data.wins || "0";
                    document.getElementById("vMatches").innerText = data.matches || "0";
                    if(data.isBanned) document.getElementById("vStatus").innerText = "BANNED";
                    app.renderLogos();
                }
                else if (role === "SCHOOL") {
                    document.getElementById("grp_school").classList.add("hidden"); // Schools don't link to schools
                    document.getElementById("p_botName").value = data.botName || "NOT_SET";
                    document.getElementById("p_mobile").value = data.mobile || "";
                    document.getElementById("vRank").innerText = data.currentRank || "N/A";
                    document.getElementById("vWins").innerText = data.wins || "0";
                    document.getElementById("vMatches").innerText = data.matches || "0";
                    app.renderLogos();
                }

                app.loadRoomPrompts();
            },

            // 4. SAVE
            saveData: async () => {
                const btn = document.getElementById("btnSave");
                const pass = document.getElementById("p_pass").value;

                // Simple Strong Pass Check
                if(pass && (pass.length < 8 || !/\d/.test(pass) || !/[!@#$%^&*]/.test(pass))) {
                    alert("PASSWORD TOO WEAK (8+ Chars, Number, Symbol)"); return;
                }

                btn.innerText = "SAVING...";
                const updates = {};
                const p = userPath;

                // Core Updates
                if(userRole === "ADMIN") {
                    updates[`${p}/city`] = document.getElementById("p_city").value;
                    updates[`${p}/bio`] = document.getElementById("p_bio").value;
                    updates[`${p}/password`] = pass || currentUser.password;
                    updates[`${p}/apiKey`] = document.getElementById("ai_key").value;
                    updates[`${p}/model`] = document.getElementById("ai_model").value;
                } else {
                    updates[`${p}/public_info/city`] = document.getElementById("p_city").value;
                    updates[`${p}/public_info/bio`] = document.getElementById("p_bio").value;
                    
                    if(userRole === "STUDENT") {
                        updates[`${p}/public_info/linkedSchool`] = document.getElementById("p_link").value;
                        updates[`${p}/public_info/avatarUrl`] = document.getElementById("p_logo_val").value;
                    } else {
                        updates[`${p}/public_info/logoUrl`] = document.getElementById("p_logo_val").value;
                    }

                    updates[`${p}/private_info/mobile`] = document.getElementById("p_mobile").value;
                    updates[`${p}/private_info/password`] = pass || currentUser.password;
                    updates[`${p}/private_info/apiKey`] = document.getElementById("ai_key").value;
                    updates[`${p}/private_info/model`] = document.getElementById("ai_model").value;
                    updates[`${p}/private_info/globalPrompt`] = document.getElementById("ai_global").value;

                    // Room Prompts
                    document.querySelectorAll(".r-prompt").forEach(el => {
                        updates[`${p}/private_info/roomPrompts/${el.dataset.room}`] = el.value;
                    });
                }

                try {
                    await update(ref(db), updates);
                    btn.innerText = "SAVED!";
                    btn.style.background = "#00CC66";
                    setTimeout(() => { btn.innerText = "SAVE CHANGES"; btn.style.background = "#000"; location.reload(); }, 1500);
                } catch(e) {
                    alert("ERROR: " + e.message);
                    btn.innerText = "RETRY";
                }
            },

            // 5. HELPERS
            switchTab: (id) => {
                document.querySelectorAll(".tab-view").forEach(e => e.classList.add("hidden"));
                document.getElementById(`tab-${id}`).classList.remove("hidden");
                document.querySelectorAll(".nav-btn").forEach(e => e.classList.remove("active"));
                // Simple active toggle
                if(id === 'profile') document.querySelectorAll(".nav-btn")[0].classList.add("active");
                if(id === 'ai') document.querySelectorAll(".nav-btn")[1].classList.add("active");
                if(id === 'admin') document.getElementById("navAdmin").classList.add("active");
            },

            logout: () => {
                sessionStorage.removeItem("vyuha_sess");
                location.reload();
            },

            renderLogos: () => {
                const seeds = ['Rohan', 'Priya', 'Max', 'Zoe', 'Titan', 'Leo'];
                const box = document.getElementById("logoList");
                const inp = document.getElementById("p_logo_val");
                inp.value = currentUser.avatarUrl || currentUser.logoUrl || "";
                box.innerHTML = "";
                seeds.forEach(s => {
                    const url = `https://api.dicebear.com/7.x/avataaars/svg?seed=${s}`;
                    const d = document.createElement("div");
                    d.className = "logo-opt";
                    if(inp.value === url) d.classList.add("selected");
                    d.innerHTML = `<img src="${url}">`;
                    d.onclick = () => {
                        document.querySelectorAll(".logo-opt").forEach(e => e.classList.remove("selected"));
                        d.classList.add("selected");
                        inp.value = url;
                    };
                    box.appendChild(d);
                });
            },

            loadRoomPrompts: async () => {
                const box = document.getElementById("roomPrompts");
                const snap = await get(child(ref(db), "rooms"));
                if(snap.exists()) {
                    box.innerHTML = "";
                    const rooms = snap.val();
                    Object.keys(rooms).forEach(k => {
                        const saved = (currentUser.roomPrompts && currentUser.roomPrompts[k]) || "";
                        box.innerHTML += `
                            <div class="field-group">
                                <label>STRATEGY: ${k} (${rooms[k].difficulty})</label>
                                <textarea class="input-std area r-prompt" data-room="${k}">${saved}</textarea>
                            </div>
                        `;
                    });
                }
            },

            loadAdminRooms: async () => {
                const box = document.getElementById("adminRoomList");
                const snap = await get(child(ref(db), "rooms"));
                box.innerHTML = "";
                if(snap.exists()) {
                    const rooms = snap.val();
                    Object.keys(rooms).forEach(k => {
                        const r = rooms[k];
                        box.innerHTML += `
                            <div class="room-item">
                                <div><strong>${k}</strong> <br> <span style="font-size:0.7rem">${r.difficulty}</span></div>
                                <div>
                                    <button onclick="app.toggleRoom('${k}', ${!r.active})" class="btn-sm">${r.active?"ON":"OFF"}</button>
                                    <button onclick="app.delRoom('${k}')" class="btn-sm red">DEL</button>
                                </div>
                            </div>
                        `;
                    });
                }
            },

            createRoom: async () => {
                const n = document.getElementById("new_r_name").value;
                const t = document.getElementById("new_r_topic").value;
                const d = document.getElementById("new_r_diff").value;
                if(n && t) {
                    await set(ref(db, `rooms/${n}`), { difficulty: d, systemPrompt: `Focus on ${t}`, active: true });
                    app.loadAdminRooms();
                    document.getElementById("new_r_name").value = "";
                }
            },

            toggleRoom: async (n, s) => { await update(ref(db, `rooms/${n}`), {active: s}); app.loadAdminRooms(); },
            delRoom: async (n) => { if(confirm("DELETE?")) { await remove(ref(db, `rooms/${n}`)); app.loadAdminRooms(); } }
        };

        // Events
        document.getElementById("btnLogin").onclick = app.login;
        window.onload = app.init;

    </script>
</body>

</html>
